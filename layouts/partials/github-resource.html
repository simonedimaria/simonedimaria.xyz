{{- /* Blowfish GitHub card that can link to a repo, file, or directory via a single URL. */ -}}
{{- $ctx := .context | default . -}}
{{- $url := trim (.url | default "") " " -}}
{{- $repoParam := trim (.repo | default "") " " -}}

{{- if and (not $url) (not $repoParam) -}}
  {{- warnf "[github-resource] url or repo is required on %s" $ctx.File.Path -}}
{{- else -}}
  {{- $clean := $url -}}
  {{- if strings.HasPrefix $clean "https://" -}}
    {{- $clean = replaceRE "^https?://(www\\.)?github.com/" "" $clean -}}
  {{- end -}}

  {{- $segments := split $clean "/" -}}
  {{- $owner := "" -}}
  {{- $repo := "" -}}

  {{- if $repoParam -}}
    {{- $repo = $repoParam -}}
    {{- with split $repo "/" -}}
      {{- if ge (len .) 2 -}}
        {{- $owner = index . 0 -}}
        {{- $repo = printf "%s/%s" (index . 0) (index . 1) -}}
      {{- end -}}
    {{- end -}}
  {{- else if ge (len $segments) 2 -}}
    {{- $owner = index $segments 0 -}}
    {{- $repo = printf "%s/%s" (index $segments 0) (index $segments 1) -}}
  {{- end -}}

  {{- if not $repo -}}
    {{- warnf "[github-resource] unable to resolve repo from url=%q on %s" $url $ctx.File.Path -}}
  {{- else -}}
    {{- $href := cond $url $url (printf "https://github.com/%s" $repo) -}}
    {{- $githubURL := printf "https://api.github.com/repos/%s" $repo -}}
    {{- $githubData := resources.GetRemote $githubURL | transform.Unmarshal -}}
    {{- $githubColors := $ctx.Site.Data.githubColors -}}

    {{- $pathLabel := "" -}}
    {{- if ge (len $segments) 3 -}}
      {{- $pathLabel = delimit (after 2 $segments) "/" -}}
    {{- end -}}

    {{- $title := .title | default "" -}}
    {{- $description := .description | default "" -}}

    {{- with $githubData }}
      {{- if not $title }}{{- $title = .full_name }}{{- end -}}
      {{- if not $description }}{{- $description = .description }}{{- end -}}
    {{- end }}

    {{- if not $title }}{{- $title = $repo -}}{{- end -}}
    {{- if not $description }}{{- $description = cond $pathLabel (printf "GitHub resource: /%s" $pathLabel) "GitHub link" -}}{{- end -}}

    {{- $language := "" -}}
    {{- with $githubData.language }}{{- $language = . -}}{{- end -}}
    {{- $stars := 0 -}}
    {{- with $githubData.stargazers_count }}{{- $stars = . -}}{{- end -}}
    {{- $forks := 0 -}}
    {{- with $githubData.forks }}{{- $forks = . -}}{{- end -}}

    {{- $langColor := "#0077b6" -}}
    {{- if and $language (isset $githubColors $language) -}}
      {{- $langColor = index $githubColors $language -}}
    {{- end -}}

    {{- $id := printf "github-resource-%s" (md5 (printf "%s-%s" $href $repo)) -}}

    <a id="{{ $id }}" target="_blank" href="{{ $href }}" class="cursor-pointer">
      <div
        class="w-full md:w-auto pt-3 p-5 border border-neutral-200 dark:border-neutral-700 border rounded-md shadow-2xl">

        <div class="flex items-center">
          <span class="text-2xl text-neutral-800 dark:text-neutral" style="margin-right:10px;">
            {{ partial "icon.html" "github" }}
          </span>
          <div
            id="{{ $id }}-full_name"
            class="m-0 font-bold text-xl text-neutral-800 decoration-primary-500 hover:underline hover:underline-offset-2 dark:text-neutral">
            {{ $title | markdownify }}
          </div>
        </div>

        <p id="{{ $id }}-description" class="m-0 mt-2 text-md text-neutral-800 dark:text-neutral">
          {{ $description | markdownify }}
        </p>

        <div class="m-0 mt-2 flex items-center">

          <span class="mr-1 inline-block h-3 w-3 rounded-full"
            style="background-color: {{ if $language }} {{- $langColor -}} {{ else }} #0077b6 {{ end }}"></span>
          <div class="m-0 mr-5 text-md text-neutral-800 dark:text-neutral">
            {{ if $language }} {{ $language }} {{ else }} null {{ end }}
          </div>

          <span class="text-md mr-1 text-neutral-800 dark:text-neutral">
            {{ partial "icon.html" "star" }}
          </span>
          <div id="{{ $id }}-stargazers" class="m-0 mr-5 text-md text-neutral-800 dark:text-neutral">
            {{ $stars }}
          </div>

          <span class="text-md mr-1 text-neutral-800 dark:text-neutral">
            {{ partial "icon.html" "fork" }}
          </span>
          <div id="{{ $id }}-forks" class="m-0 mr-5 text-md text-neutral-800 dark:text-neutral">
            {{ $forks }}
          </div>

          {{- if $pathLabel }}
            <code class="px-2 py-1 rounded bg-neutral-200 text-neutral-800 dark:bg-neutral-800 dark:text-neutral-100 text-sm">
              /{{ $pathLabel }}
            </code>
          {{- end }}

        </div>

      </div>
      <script>
        fetch({{ $githubURL }}, {
          headers: new Headers({
            'User-agent': 'Mozilla/4.0 Custom User Agent'
          })
        })
          .then(response => response.json())
          .then(data => {
            if (data.full_name)
              document.getElementById('{{ $id }}-full_name').innerHTML = data.full_name;
            if (data.description)
              document.getElementById('{{ $id }}-description').innerHTML = data.description;
            if (data.stargazers_count !== undefined)
              document.getElementById('{{ $id }}-stargazers').innerHTML = data.stargazers_count;
            if (data.forks !== undefined)
              document.getElementById('{{ $id }}-forks').innerHTML = data.forks;
          })
          .catch(error => console.error(error))
      </script>
    </a>
  {{- end -}}
{{- end -}}
